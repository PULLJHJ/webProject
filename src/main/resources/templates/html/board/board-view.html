<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/x-icon" href="/imgs/favicon.ico">
<title>ì§€ì¤‘í•´</title>
<link rel="stylesheet" href="/css/board-view.css">
<div th:replace="html/fragment/header.html :: header-head"></div>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=abb76285215945e8b22290d7759dcd17&libraries=services"></script>
<script src="/js/data-processing.js"></script>
<script src="/js/report.js"></script>
<script src="https://cdn.jsdelivr.net/npm/animejs"></script>
</head>
<body>
	<div th:replace="html/fragment/header.html :: header-container"></div>
	<div class="body-container">
		<div class="seller">
			<div id="board">
				<button type="button" onclick="location.href=`/html/board/board-update?biNum=${biNum}`">ìˆ˜ì •</button>
				<button onclick="delBoard()">ì‚­ì œ</button>
			</div>
			<div id="deal">
				<button id="dealButton" onclick="getChatRoomList()">ê±°ë˜ ì™„ë£Œ</button>
			</div>
		</div>
		
		<div class="buyer">
			<div id="chatting">
				<button id="startChatBtn" onclick="startChat()">ì±„íŒ…í•˜ê¸°</button>
			</div>
			<div id="likeIt">
				<button id="likeBtn" onclick="likeChange()">
				<img id="heart" src="" alt="ê´€ì‹¬">
				</button>
			</div>
		</div>
		
		<div class="boardDiv">
			<div id="head">
				<h1 id="biTitle"></h1>
				<p id="ago"></p> &nbsp;âˆ™
				<p id="biStat"></p><br>
				<p id="info">ì±„íŒ… <span id="chatCnt"></span>  âˆ™ ê´€ì‹¬ <span id="likeCnt"></span>  âˆ™ ì¡°íšŒ <span id="biViews"></span></p>
			</div>
			<div id="price-field">
				<p><span id="price"></span>ì›</p>
			</div>
			<div id="profile">
				<a href="#" onclick="goProfile()" id="goProfile">
					<img src="/imgs/user.png" alt="user-image">
					<p id="uiName"></p>
				</a>
			</div>
			<hr>
			<div class="board-form" id="content">
				<p id="name-field">ìƒí’ˆëª… : <span id="biName"></span></p>
				<p id="desc-field">
					<span id="biContent"></span>
				</p>
				<div class="board-form" id="mapDiv">
					<p>ê±°ë˜ í¬ë§ ì£¼ì†Œ : <span id="biAddr"></span></p><br>
					<p>íŒë§¤ì ì§€ì • ì¥ì†Œ : <span id="biLoca"></span></p>
					<div id="map" style="width:100%;height:320px;"></div>
				</div>
			</div>
			<div class="board-form" id="file-images">
				<div id="file-slider"></div>
				<button class="prev-button">&lang;</button>
	      		<button class="next-button">&rang;</button>
	      		<button class="view-button" onclick="viewImg()">ğŸ”ï¸</button>
      		</div>
		</div>
	</div>
	<div class="modal">
		<div class="chat-modal">
			<div id="modal-desc">ê±°ë˜í•œ ìƒëŒ€ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
			<div id="chatRoomBody"></div>
			<div id="modal-btn">
				<button id="cancel-btn" onclick="cancel()">ì·¨ì†Œ</button>
				<button id="endSell-btn" onclick="endSell()">ì´ ì‚¬ëŒê³¼ ê±°ë˜í–ˆì–´ìš”</button>
			</div>
		</div>
	</div>
	<script>
		const biNum = '[[${param.biNum}]]';
		const uiNum = '[[${param.uiNum}]]';
		console.log(uiNum);
		let selectedChatInfo = {};
		let board;
		let res;
		window.addEventListener('load', async function(){
			res = await fetch(`/board-infos/${biNum}`);
			board = await res.json();
			console.log(board);
			
			if (board.biStat === 'íŒë§¤ì™„ë£Œ') {
                document.querySelector('#dealButton').style.display = "none";
            }

			// ì‘ì„±ì : ìˆ˜ì •, ì‚­ì œ, íŒë§¤ ì™„ë£Œ ë²„íŠ¼ì´ ë³´ì´ë„ë¡
			// ì‘ì„±ì ì™¸ : ê´€ì‹¬ ë²„íŠ¼ì´ ë³´ì´ë„ë¡, ìµœê·¼ ë°©ë¬¸ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
			if(!board.author){
				document.querySelector('.seller').style.display = "none";
				// ê´€ì‹¬ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
				if(board.like){
					document.querySelector('#heart').src = "/imgs/full-heart.png";
				}else{
					document.querySelector('#heart').src = "/imgs/empty-heart.png";
				}
				// ìµœê·¼ ë°©ë¬¸í•œ ê²Œì‹œë¬¼ì— ì¶”ê°€
				res = await fetch(`/viewed-infos/${biNum}`, {
					method: 'POST'
				})
			}else{
				document.querySelector('.buyer').style.display = "none";
			}
			
			// ì´ë¯¸ì§€ íŒŒì¼
			boardFiles = board.files;
			for(let i=0; i<boardFiles.length; i++){
				const boardFile = boardFiles[i];
				console.log(boardFile);
				const html = `<div class="file-slide" id="file${i+1}"><img src="${boardFile.fiPath}" id="img${i+1}"></div>`;
				document.querySelector('#file-slider').insertAdjacentHTML('beforeend',html);  
			}
			
			// í˜„ì¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì–¼ë§ˆ ì „ì— ìˆ˜ì •í–ˆëŠ”ì§€
			document.querySelector('#ago').innerText = `ëŒì˜¬ ${calculateTime(board.credat, board.cretim)}`;
			
			// ê°€ê²© ì½¤ë§ˆë¡œ í‘œì‹œ
			document.querySelector('#price').innerText = priceToString(board.biPrice);
			
			// ë‹¤ë¥¸ í‚¤ ê°’
			for(let key in board){
				if(document.querySelector('#' + key)){
					document.querySelector('#' + key).innerText = board[key];
				}
			}
			
			var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div 
		    mapOption = {
		        center: new kakao.maps.LatLng(33.450701, 126.570667), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
		        level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
		    };  
		
			// ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤    
			var map = new kakao.maps.Map(mapContainer, mapOption); 
			
			// ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
			var geocoder = new kakao.maps.services.Geocoder();
			
			// ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
			geocoder.addressSearch(board.biAddr, function(result, status) {
			
			    // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´ 
			     if (status === kakao.maps.services.Status.OK) {
			
			        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
			
			        // ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œí•©ë‹ˆë‹¤
			        var marker = new kakao.maps.Marker({
			            map: map,
			            position: coords
			        });
			
			        // ì¸í¬ìœˆë„ìš°ë¡œ ì¥ì†Œì— ëŒ€í•œ ì„¤ëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤
			        var infowindow = new kakao.maps.InfoWindow({
			            content: '<div style="width:150px;text-align:center;padding:6px 0;">ê±°ë˜ í¬ë§ ì£¼ì†Œ ìœ„ì¹˜</div>'
			        });
			        infowindow.open(map, marker);
			
			        // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
			        map.setCenter(coords);
			    } 
			});
			
			
			// ì±„íŒ… ê°œìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
			
			
			// íŒŒì¼ ìŠ¬ë¼ì´ë“œ			
			const slider = document.querySelector('#file-slider');
	        const slides = slider.querySelectorAll('.file-slide');
	        const prevButton = document.querySelector('.prev-button');
	        const nextButton = document.querySelector('.next-button');
	        
	        let slideIdx = 0;
	
	        // ì´ì „ ìŠ¬ë¼ì´ë“œë¡œ ì´ë™
	        prevButton.addEventListener('click', function () {
				slideIdx = (slideIdx - 1 + slides.length) % slides.length;
				updateSlide();
	        });
	
	        // ë‹¤ìŒ ìŠ¬ë¼ì´ë“œë¡œ ì´ë™
	        nextButton.addEventListener('click', function () {
				slideIdx = (slideIdx + 1) % slides.length;
				updateSlide();
	        });
	
	        // ìŠ¬ë¼ì´ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
			function updateSlide() {
			    const slideWidth = slides[0].clientWidth;
			    const maxIdx = slides.length - 1;
			    
			    if(slideIdx >= 0 && slideIdx <= maxIdx){
					slider.style.transform = `translateX(-${slideIdx * slideWidth}px)`;
			    }
			    
			    if(slideIdx < 0){
			        slideIdx = 0; // ì²˜ìŒ ìŠ¬ë¼ì´ë“œë¡œ ê³ ì •
			    }
			    
			    if(slideIdx > maxIdx){
			        slideIdx = maxIdx; // ë ìŠ¬ë¼ì´ë“œë¡œ ê³ ì •
			    }
			}
		});
		
		// ê²Œì‹œë¬¼ ì‚­ì œ
		async function delBoard(){
			if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
					const res = await fetch(`/board-infoList/${biNum}`, {
					method: 'PATCH'
				});
				if(res.ok){
					alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
					location.href='/html/board/board-list';
				}else{
					alert('ê²Œì‹œë¬¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				}
			}
		}
		
	    
	    // í´ë¦­í–ˆì„ ë•Œ ê´€ì‹¬ ëª©ë¡ ì¶”ê°€, ì‚­ì œ
		async function likeChange(){
			let res = await fetch(`/like-infos/${biNum}`);
			const likeCnt = document.querySelector('#likeCnt').textContent;
			const isLike = await res.json();
			if(isLike === 1){
				document.querySelector('#likeCnt').textContent = parseInt(likeCnt) - 1;
				res = await fetch(`/like-infos/${biNum}`, {
					method: 'DELETE'
				});
				if(res.ok){
					document.querySelector('#heart').src = "/imgs/empty-heart.png";
				}else{
					alert('ê´€ì‹¬ ëª©ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
				}
			}else{
				res = await fetch(`/like-infos/${biNum}`, {
					method: 'POST'
				});
				const addlike = await res.json();
				if(addlike === 1){
					document.querySelector('#likeCnt').textContent = parseInt(likeCnt) + 1;
					anime({
						begin: function(anim){
							document.querySelector('#heart').src = "/imgs/full-heart.png";
						},
						targets: '#heart',
						easing: 'cubicBezier(.7, .1, .1, .3)',
						delay: 0,
						keyframes: [
							{scale: 1.6, duration: 100},
							{scale: 1, duration: 200}
						]
					})
				}else{
					alert('ê´€ì‹¬ ëª©ë¡ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				}
			}
		}
		
		async function startChat(){
			const param = {
				biNum:biNum,
				sellerUiNum:board.uiNum
			};
			const createChatRoom = await fetch('/create-chat-room',{
				method:'POST',
				headers:{
					'Content-Type':'application/json;charset=UTF-8'
				},
				body:JSON.stringify(param)
			});
			const createChatRoomRes = await createChatRoom.json();
			if(createChatRoomRes === 1){
				location.href=`/html/chat/chatRoomList?biNum=${biNum}`
			}else{
				alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
			}
		}

		async function getChatRoomList() {
			document.querySelector('.modal').style.display="flex";
			const body = document.querySelector('body');
			body.style.overflow="hidden";
			body.style.height="100%";
			
		    const responseChatRoomList = await fetch('/get-chat-room-list');
		
		    if (!responseChatRoomList.ok) {
		        console.error('ì±„íŒ… ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		        return;
		    }
		
		    const chatRoomList = await responseChatRoomList.json();
		
		    let html = '';
		    let count = 1;
		
		    for (const chatRoom of chatRoomList) {
		        if (chatRoom.biTitle === board.biTitle) {
		            html += '<div>';
		            html += `<input type="radio" name="chatRadio" value="${chatRoom.biNum}-${chatRoom.sellerUiNum}-${chatRoom.buyerUiNum}-${chatRoom.ciNum}" />`;
		            html += `<label>${count++}. ${chatRoom.opUiName}</label>`;
		            html += '</div>';
		        }
		    }
		
		    document.querySelector('#chatRoomBody').innerHTML = html;
		
		    // ë¼ë””ì˜¤ ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒí•œ ì±„íŒ… ì •ë³´ ì €ì¥
		    const radioButtons = document.querySelectorAll('input[name="chatRadio"]');
		    radioButtons.forEach(function (radioButton) {
		        radioButton.addEventListener('click', function () {
		            const values = radioButton.value.split('-');
		            selectedChatInfo = {
		                biNum: values[0],
		                sellerUiNum: values[1],
		                buyerUiNum: values[2],
		                ciNum: values[3]
		            };
		            console.log("biNum=>", selectedChatInfo.biNum);
		            console.log("sellerUiNum=>", selectedChatInfo.sellerUiNum);
		            console.log("buyerUiNum=>", selectedChatInfo.buyerUiNum);
		            console.log("ciNum=>", selectedChatInfo.ciNum);
		        });
		    });
		}
		
		
		// ëª¨ë‹¬ì°½ ë‹«ê¸°
		function cancel(){
			document.querySelector('.modal').style.display="none";
			const body = document.querySelector('body');
			body.style.overflow="visible";
		}

		async function endSell() {
		    if (!selectedChatInfo || Object.keys(selectedChatInfo).length === 0) {
		        alert('ì±„íŒ…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
		        return;
		    }
		
		    const { biNum, sellerUiNum, buyerUiNum, ciNum } = selectedChatInfo;
		
		    const queryParams = new URLSearchParams(window.location.search);
		    const boardBiNum = queryParams.get('biNum');
		
		    const responseUpdateBiStat = await fetch(`/board-infos/update-bi-stat/${boardBiNum}`, {
		        method: 'PATCH',
		    });
		
		    if (!responseUpdateBiStat.ok) {
		        console.error('updateBiStatì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		        return;
		    }
		
		    const responseDeal = await fetch(`/insert-deal-info?biNum=${biNum}&sellerUiNum=${sellerUiNum}&buyerUiNum=${buyerUiNum}&ciNum=${ciNum}`, {
		        method: 'POST',
		    });
		    console.log(biNum);
		    console.log(sellerUiNum);
		    console.log(buyerUiNum);
		    console.log(ciNum);
		
		    if (responseDeal.ok) {
		        const { diNum } = await responseDeal.json();
		
		        const orderInfo = {
		            diNum: diNum,
		        };
		
		        const responseOrder = await fetch('/add-order-info', {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		            },
		            body: JSON.stringify(orderInfo),
		        });
		
		        if (responseOrder.ok) {
		            alert('ê±°ë˜ ë° ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
		            console.log(diNum);
		
		            fetchbuyerUiNumAndRedirect(diNum);
		        } else {
		            alert('ê±°ë˜ ë˜ëŠ” ì£¼ë¬¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		            console.log(diNum);
		        }
		    } else {
		        alert('ê±°ë˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		    }
		}



	async function fetchbuyerUiNumAndRedirect(diNum) {
	    const oiNumRes = await fetch(`/fetch-buyer-num?diNum=${diNum}`);
	
	    if (oiNumRes.ok) {
	        const oiNumData = await oiNumRes.json();
	
	        const oiNum = oiNumData.oiNum;
	        const diNumFromServer = oiNumData.diNum;
	        const buyerUiNum = oiNumData.buyerUiNum;
	
	        window.location.href = `/html/rank/rank-add-buyer?oiNum=${oiNum}&diNum=${diNumFromServer}&buyerUiNum=${buyerUiNum}`;
	    } else {
	        alert("ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	    }
	    console.log("oiNum:", oiNum);
	    console.log("diNumFromServer:", diNumFromServer);
	    console.log("buyerUiNum:", buyerUiNum);
	}
	
	function goProfile(){
		location.href=`/html/user/profile?uiNum=${uiNum}`;
	}
	</script>
</body>
</html>